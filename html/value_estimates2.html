<html>

<head>
    <link rel="stylesheet" type="text/css" href="../css/bootstrap-grid.min.css">
    <link rel="stylesheet" type="text/css" href="../css/bootstrap-beta.min.css">
    <link rel="stylesheet" type="text/css" href="../css/font-awesome.min.css">

    <link rel="stylesheet" type="text/css" href="../css/common.css">
    <link rel="stylesheet" type="text/css" href="../css/estimations.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="../js/jspdf.min.js"></script>
    <script src="../js/html2canvas.min.js"></script>
    <script src="../js/html2pdf.js"></script>

    <link href="assets/bootstrap-table.css" rel="stylesheet">
    <script src="assets/bootstrap-table.js"></script>    
    <!-- BugHerd -->
    <script type=‘text/javascript’>
    (function (d, t) {
     var bh = d.createElement(t), s = d.getElementsByTagName(t)[0];
     bh.type = ‘text/javascript’;
     bh.src = ’https://www.bugherd.com/sidebarv2.js?apikey=jisegynaoqxeapyedex9kg';
     s.parentNode.insertBefore(bh, s);
     })(document, ‘script’);
    </script>
</head>
<nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
    <div class="container-fluid ml-3 mr-3">
        <a class="navbar-brand" href="#">
            <img src="/images/logo_color_beta.png" class="logo" />
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo01" aria-controls="navbarTogglerDemo01"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarTogglerDemo01">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" href="#">Home</a>
                </li>
                <li class="navbar-item">
                    <a class="nav-link" href="#">About</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
<body class="fs-md open-sans-light">

<div class="container-fluid">
    <div class="block">
        <div class="row top m-0">
            <div class="col-8 top-title nowrap h2 pl-0">Oreeva Estimate</div>
            <div class="col-4 text-right pr-0">
                <div id="price" class="h1 font-weight-bold pound">222,222</div>
                <div id="confidence" class="text-uppercase open-sans-bold fs-xs confidence-good">Good Confidence</div>
            </div>
        </div>

        <!-- Params -->
        <div class="row params m-0">
            <div class="col-xs-12 col-md-6 push-md-6 block params-map">
                todo map
            </div>
            <div class="col-xs-12 col-md-6 pull-md-6 block params-form">
                todo form
            </div>
        </div>

    </div>
    <!-- Price trend -->
    <div class="block trend" hidden>
        <h2 id="trend-header">Price Trend SL1</h2>
        <div class="d-flex justify-content-between text-center" id="trend">
            <div class="d-flex flex-column align-items-center">
                <div class="">Last 12 months</div>
                <div class="pb-2 fs-xl font-weight-bold">-4%</div>
                <!-- todo: image for trend direction -->
                <div><i class="fa fa-lg fa-bar-chart trend-down"></i></div>
            </div>
            <div class=" d-flex flex-column align-items-center">
                <div class="">3 years</div>
                <div class="pb-2 fs-xl font-weight-bold">+5%</div>
                <div><i class="fa fa-lg fa-bar-chart trend-up"></i></div>
            </div>
            <div class=" d-flex flex-column align-items-center">
                <div class="">5 years</div>
                <div class="pb-2 fs-xl font-weight-bold">+7%</div>
                <div><i class="fa fa-lg fa-bar-chart trend-up"></i></div>
            </div>
            <div class=" d-flex flex-column align-items-center">
                <div class="">10 years</div>
                <div class="pb-2 fs-xl font-weight-bold">+15%</div>
                <div><i class="fa fa-lg fa-bar-chart trend-up"></i></div>
            </div>
        </div>
    </div>

    <!-- Market analytics -->
    <div class="row m-0 market">
        <div class="col-xs-12 col-md-4 push-md-8 block market-facts" hidden>
            <div class="d-flex flex-column align-items-center">
                <h2 id="market-facts-header" class="align-self-start align-self-md-center mb-md-0">Market Facts</h2>
                <div id="market-facts-subheader" class="align-self-start align-self-md-center mb-2 fs-sm">Flats - SL1</div>
                <select id="market-facts-sel-period" class="custom-select d-none d-md-inline-block">
                    <option selected>Last 12 months</option>
                    <option value="1">One</option>
                    <option value="2">Two</option>
                    <option value="3">Three</option>
                </select>
                <div id="market-facts-sales" class="d-flex flex-column align-items-center">
                    <div class="pt-4">Number of Sales</div>
                    <div id="market-facts-sales-val" class="fs-lg font-weight-bold">250</div>
                </div>
                <div id="market-facts-average" class="d-flex flex-column align-items-center">
                    <div class="pt-4">Average &#163; per sq.ft.</div>
                    <div id="market-facts-average-val" class="fs-lg font-weight-bold">&#163; 1,560</div>
                </div>
                <div id="market-facts-average-paid" class="d-flex flex-column align-items-center">
                    <div class="pt-4">Average &#163; paid</div>
                    <div id="market-facts-average-paid-val" class="fs-lg font-weight-bold">&#163; 230,000</div>
                </div>
                <div id="market-facts-price-change" class="d-flex flex-column align-items-center">
                    <div class="pt-4">Average &#163; paid</div>
                    <div id="market-facts-price-change-val" class="fs-lg font-weight-bold trend-down"><i class="fa fa-bar-chart"></i> -4</div>
                </div>
            </div>
        </div>
        <div class="col-sm-12 block market-chart">
            <div class="d-flex justify-content-end align-items-center">
                <h2 id="market-chart-header" class="mr-auto m-0">Market Analytics</h2>
                <select id="market-chart-sel-param" class="custom-select d-none d-md-inline-block">
                    <option selected>Price (per sq.ft.)</option>
                    <option value="1">One</option>
                    <option value="2">Two</option>
                    <option value="3">Three</option>
                </select>
                <select id="market-chart-sel-period" class="custom-select d-none d-md-inline-block">
                    <option selected>Last 12 months</option>
                    <option value="1">One</option>
                    <option value="2">Two</option>
                    <option value="3">Three</option>
                </select>
            </div>

            <div>
                todo plotly
            </div>
        </div>
    </div>

    <!-- Recent sales -->

    <div class="block trends-history">
        <h2>Recent sales in the area</h2>
        <!--<div class="table-responsive">-->
            <table id="table" class="table table-responsive table-no-bordered">
                <thead>
                <tr>
                    <th data-formatter="runningFormatter">№</th>
                    <th data-field="date">Transaction date</th>
                    <th data-field="address">Address</th>
                    <th data-align="center" data-halign="center" data-field="total_floor_area" data-formatter="decimalsFormatter">Floor Area</th>
                    <th data-align="center" data-halign="center" data-field="type" data-formatter="typeFormatter">Type</th>
                    <th data-align="center" data-halign="center" data-field="number_of_rooms" data-formatter="decimalsFormatter">Rooms</th>
                    <th data-align="center" data-halign="center" data-field="new_price" data-formatter="decimalsDelimiterFormatter">Price</th>
                </tr>
                </thead>
            </table>
        <!--</div>-->
    </div>


    <div id="loading">
        <div class="loader-circle"></div>
        <div class="loader-line-mask">
            <div class="loader-line"></div>
        </div>
    </div>


    <div id="sorryModal" class="modal fade modal-white" role="dialog">
        <div class="modal-dialog" style="margin-top: 20vh;">

            <div class="modal-content">
                <div class="modal-header">
                    <button aria-label="Close" class="close modal-close" data-dismiss="modal" type="button">
                        <span aria-hidden="true">×</span>
                    </button>
                    <h4 class="modal-title">Sorry, we don’t have enough data</h4>
                </div>
                <div class="modal-body text-center">
                    <p>We do not have enough data to provide an estimate for this property. Please try again by entering a
                        different address.</p>
                </div>
                <div class="modal-footer text-center">
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="location.reload();">Try
                        again
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

    <script>

        function showSorryModal() {
            $("#sorryModal").modal("show");
            $(".container").addClass("wrapper")
        }

        function hideSorryModal(){
            $("#sorryModal").modal("hide");
            $(".container").removeClass("wrapper")
        }
       

        var prediction = {
            age : "N",
            area : "436",
            duration : "L",
            floor : "1st",
            latitude : 51.51848,
            longitude : -0.5738671,
            model_type : "C",
            postcode : "SL2 5RJ",
            propType : "F",
            propertyAddress : "183 Holmedale, SL2 5RJ",
            propertyType : "Flat",
            rooms : "2",
            street : "HOLMEDALE"
        };
        
        $('#sorryModal').on('hidden.bs.modal', function () {
            hideSorryModal();
        });

        $("#propertyName").text(prediction.propertyAddress);
        $("#propertyType").text(prediction.propertyType);
        $("#rooms").text(prediction.rooms);
        $("#floorLevel").text(prediction.floor);
        $("#floorArea").text(prediction.area);

        $("#loading").css("display", "block");
        
        getPredictionAndStatisticStub();
        function getPredictionAndStatisticStub() {
            var json = {
                confidence: 99.0,
                max: 300000.0,
                min: 230000.0,
                price: 231000.0,
                psf_max: 688.07336,
                psf_min: 527.52295,
                similarities: [
                    {
                        address: "1 ABBEY CLOSE , SL1 5HZ",
                        age: "N",
                        total_floor_area: 250,
                        date: "2017-01-01",
                        floor: "2nd",
                        latitude: 51.51953,
                        longitude: -0.647889,
                        new_price: 200000,
                        type: "Flat",
                        number_of_rooms: 3,
                        similarity: 90
                    },
                    {
                        address: "36 LINCOLN WAY, SL1 5RG",
                        age: "N",
                        total_floor_area: 290,
                        date: "2017-01-01",
                        floor: "2nd",
                        latitude: 51.51953,
                        longitude: -0.647889,
                        new_price: 200500,
                        type: "Flat",
                        number_of_rooms: 4,
                        similarity: 95
                    },
                    {
                        address: "51 TOBERMORY CLOSE, SL3 7JG",
                        age: "N",
                        total_floor_area: 230,
                        date: "2017-01-01",
                        floor: "2nd",
                        latitude: 51.49719,
                        longitude: -0.553413,
                        new_price: 200000,
                        type: "Flat",
                        number_of_rooms: 3,
                        similarity: 90
                    }
                ]
            }
            
            if (json.confidence == 0) {
                showSorryModal();
                return;
            }

            var costSF = json.price / prediction.area;
            var price = Math.ceil(json.price / 100) * 100;
            $("#price").text(delimeter(price));
            $("#priceSF").text(delimeter(costSF));

            if (json.similarities == undefined || json.similarities.length == 0) {
                setConfidence(0);
                showSorryModal();
            } else {
                setConfidence(json.confidence);

                $('#table').bootstrapTable({
                    data: json.similarities
                });
            }
        }
        
        function setConfidence(value) {
            var $confidenceBar = $("#confidence");
            $confidenceBar.removeClass("confidence-high");
            $confidenceBar.removeClass("confidence-good");
            $confidenceBar.removeClass("confidence-poor");
            $confidenceBar.removeClass("confidence-zero");
            var type = "zero";
            if (value > 95) {
                type = "good";
            } else if (value > 90) {
                type = "average";
            } else if (value > 80) {
                type = "poor";
            }
            else
            {
                showSorryModal();
            }
            $confidenceBar.addClass("confidence-" + type);
            $("#confidence").text(type + " confidence")
        }

        function delimeter(num) {
            return (Math.round(num)).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function generatePDF() {
            var element = document.getElementById("content");
            html2pdf(element, {
                margin: 0,
                filename: "oreeva_report.pdf",
                html2canvas: {dpi: 192},
                jsPDF: {unit: 'pt', format: 'a3', orientation: 'portrait'}
            });
        }

        function decimalsFormatter(value) {
            return Math.round(value);
        }

        function decimalsDelimiterFormatter(value) {
            return delimeter(Math.round(value));
        }

        function typeFormatter(value) {
            return value;
        }

        function runningFormatter(value, row, index) {
            return index+1;
        }

        function openMainPage() {
            window.location.href = "index2.html";
        }

        function per(num, amount) {
            return num * amount / 100;
        }

    </script>

</body>

</html>